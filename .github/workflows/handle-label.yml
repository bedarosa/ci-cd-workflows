name: Handle PR Labels

on:
  workflow_call:
    inputs:
      labels:
        required: true
        type: string
    outputs:
      ORBITDOTNET_FOUND:
        value: ${{ jobs.handle_label.outputs.ORBITDOTNET_FOUND }}
      ORBITDOTNET_RESULTS_FOUND:
        value: ${{ jobs.handle_label.outputs.ORBITDOTNET_RESULTS_FOUND }}

jobs:
  handle_label:
    runs-on: ubuntu-latest
    outputs:
      ORBITDOTNET_FOUND: ${{ steps.check_labels.outputs.ORBITDOTNET_FOUND }}
      ORBITDOTNET_RESULTS_FOUND: ${{ steps.check_labels.outputs.ORBITDOTNET_RESULTS_FOUND }}
    steps:
      - name: Check PR Labels
        id: check_labels
        run: |
          labels="${{ inputs.labels }}"
          echo "Rótulos: $labels"

          if echo "$labels" | grep -q OrbitDotnet,; then
            echo "O rótulo 'OrbitDotnet' está presente."
            echo "ORBITDOTNET_FOUND=true" >> $GITHUB_OUTPUT
          else
            echo "O rótulo 'orbitdotnet' NÃO está presente."
            echo "ORBITDOTNET_FOUND=false" >> $GITHUB_OUTPUT
          fi

          if echo "$labels" | grep -q OrbitDotnet.Results,; then
            echo "O rótulo 'results' está presente."
            echo "ORBITDOTNET_RESULTS_FOUND=true" >> $GITHUB_OUTPUT
          else
            echo "O rótulo 'OrbitDotnet.Results' NÃO está presente."
            echo "ORBITDOTNET_RESULTS_FOUND=false" >> $GITHUB_OUTPUT
          fi
  
  handle_label_in_master:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR Labels on master
        id: check_labels_master
        run: |
          # Obter o commit SHA do push
          commit_sha="${{ github.sha }}"
          
          # Usar a API do GitHub para encontrar o PR associado ao commit
          pr_url=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/commits/${commit_sha}/pulls" | jq -r '.[0].url')

          if [ "$pr_url" != "null" ]; then
            echo "PR URL: $pr_url"
            # Obter as labels do PR
            labels=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$pr_url" | jq -r '.labels[].name')
            echo "Labels do PR:"
            echo "$labels" | tr '\n' ',' | sed 's/,$//'
            echo "LABELS=$labels" >> $GITHUB_ENV
          else
            echo "Nenhum PR associado a este commit."
          fi
